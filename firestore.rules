rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /orders/{orderId} {
      // 주문 생성: 로그인한 사용자 누구나
      allow create: if request.auth != null;

      // 고객: 본인 주문만 읽기/삭제
      allow read, delete: if request.auth != null
        && resource.data.uid == request.auth.uid;

      // 관리자(이메일/비밀번호 로그인): 전체 주문 읽기/수정
      allow read, update: if request.auth != null
        && request.auth.token.firebase.sign_in_provider == 'password';

      // 배송기사(익명 로그인): 배차된 주문 읽기 + 배송완료 처리
      allow read: if request.auth != null
        && resource.data.deliveryVehicle != null;
      allow update: if request.auth != null
        && resource.data.deliveryVehicle != null
        && request.resource.data.status == 'delivered'
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']);
    }

    match /payments/{paymentId} {
      // 고객: 본인 사업자번호 입금 내역 읽기
      allow read: if request.auth != null;

      // 관리자: 전체 입금 CRUD
      allow read, write: if request.auth != null
        && request.auth.token.firebase.sign_in_provider == 'password';
    }

    match /profiles/{profileId} {
      allow read, write: if request.auth != null;
    }

  }
}
